#!/usr/bin/env python3
"""
oil_price_forecast.py
Minimal, robust, go-live safe oil forecast (Brent + WTI)

- Yahoo Finance only
- Trend filter
- Trade only on strong probabilities
- Writes forecast_output.txt (overwrite each run)
"""

import yfinance as yf
import pandas as pd
import numpy as np
from datetime import datetime
from sklearn.linear_model import LogisticRegression

# =====================
# CONFIG
# =====================
START_DATE = "2012-01-01"

BRENT = "BZ=F"
WTI = "CL=F"

PROB_LONG = 0.57
PROB_SHORT = 0.43

OUTPUT_FILE = "forecast_output.txt"

# =====================
# LOAD DATA
# =====================
def load_prices(symbol):
    df = yf.download(symbol, start=START_DATE, progress=False)
    if "Close" not in df.columns or len(df) < 300:
        raise RuntimeError(f"Invalid data for {symbol}")
    return df[["Close"]].rename(columns={"Close": symbol})

# =====================
# FEATURES
# =====================
def build_features(df):
    df = df.copy()
    df["ret"] = df.iloc[:, 0].pct_change()
    df["ret_lag1"] = df["ret"].shift(1)
    df["ret_lag2"] = df["ret"].shift(2)
    df["vol5"] = df["ret"].rolling(5).std().shift(1)
    df["sma50"] = df.iloc[:, 0].rolling(50).mean()
    df["trend_up"] = (df.iloc[:, 0] > df["sma50"]).astype(int)

    df["target"] = (df["ret"].shift(-1) > 0).astype(int)
    df = df.dropna()
    return df

# =====================
# MODEL
# =====================
def train_model(df):
    X = df[["ret_lag1", "ret_lag2", "vol5"]]
    y = df["target"]
    model = LogisticRegression(max_iter=1000)
    model.fit(X, y)
    return model

# =====================
# FORECAST
# =====================
def forecast(symbol):
    prices = load_prices(symbol)
    df = build_features(prices)
    model = train_model(df)

    last = df.iloc[-1]
    X_last = last[["ret_lag1", "ret_lag2", "vol5"]].values.reshape(1, -1)
    prob_up = float(model.predict_proba(X_last)[0][1])

    trend_ok = bool(last["trend_up"])
    price = float(prices.iloc[-1, 0])

    if prob_up >= PROB_LONG and trend_ok:
        signal = "LONG"
    elif prob_up <= PROB_SHORT and not trend_ok:
        signal = "SHORT"
    else:
        signal = "NO_TRADE"

    return {
        "symbol": symbol,
        "price": price,
        "prob_up": prob_up,
        "trend_up": trend_ok,
        "signal": signal
    }

# =====================
# OUTPUT
# =====================
def write_output(brent, wti):
    now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

    lines = []
    lines.append("===================================")
    lines.append("        OIL PRICE FORECAST")
    lines.append("===================================")
    lines.append(f"Run time (UTC): {now}")
    lines.append("")

    for r in (brent, wti):
        lines.append(f"Market: {r['symbol']}")
        lines.append(f"Price : {r['price']:.2f}")
        lines.append(f"Prob UP: {r['prob_up']:.2%}")
        lines.append(f"Trend UP: {r['trend_up']}")
        lines.append(f"Signal: {r['signal']}")
        lines.append("-----------------------------------")

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write("\n".join(lines))

# =====================
# MAIN
# =====================
def main():
    brent = forecast(BRENT)
    wti = forecast(WTI)
    write_output(brent, wti)
    print("[OK] Forecast written to forecast_output.txt")

if __name__ == "__main__":
    main()
