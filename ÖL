#!/usr/bin/env python3
"""
oil_price_forecast.py
Clean, robust, professional oil forecast (WTI + Brent)

- Yahoo Finance only
- No leakage
- Trend filter
- Probability-based trading signal
"""

import json
import numpy as np
import pandas as pd
from datetime import datetime

import yfinance as yf
from sklearn.linear_model import LogisticRegression
from sklearn.model_selection import TimeSeriesSplit
from sklearn.metrics import accuracy_score

# ======================
# CONFIG
# ======================
START_DATE = "2012-01-01"

SYMBOL_WTI = "CL=F"
SYMBOL_BRENT = "BZ=F"

PROB_THRESHOLD = 0.57   # trade only above this
OUTPUT_TXT = "oil_forecast.txt"
OUTPUT_JSON = "oil_forecast.json"


# ======================
# DATA LOADING
# ======================
def load_prices():
    wti = yf.download(SYMBOL_WTI, start=START_DATE, progress=False)
    brent = yf.download(SYMBOL_BRENT, start=START_DATE, progress=False)

    df = pd.DataFrame({
        "WTI": wti["Close"],
        "Brent": brent["Close"]
    }).dropna()

    return df


# ======================
# FEATURES
# ======================
def build_features(df):
    df = df.copy()

    # Returns
    df["WTI_ret"] = df["WTI"].pct_change()
    df["Brent_ret"] = df["Brent"].pct_change()

    # Momentum
    for n in [3, 5, 10]:
        df[f"WTI_mom_{n}"] = df["WTI"].pct_change(n)
        df[f"Brent_mom_{n}"] = df["Brent"].pct_change(n)

    # Trend filter
    df["WTI_SMA10"] = df["WTI"].rolling(10).mean()
    df["WTI_SMA30"] = df["WTI"].rolling(30).mean()

    df["Trend_UP"] = (df["WTI_SMA10"] > df["WTI_SMA30"]).astype(int)

    # Target: next day direction
    df["Target"] = (df["WTI_ret"].shift(-1) > 0).astype(int)

    df = df.dropna()
    return df


# ======================
# MODEL
# ======================
def train_model(df, features):
    X = df[features]
    y = df["Target"]

    tscv = TimeSeriesSplit(n
